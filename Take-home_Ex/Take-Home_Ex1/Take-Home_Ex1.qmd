---
title: "Take Home Exercise 1"
author: Johsuan Huang
date: "Febuary 1, 2025"
date-modified: "last modified"
description: "Ship performance Analysis"
categories: []
execute:
  echo: true
  eval: true
  warning: false
  freeze: true
---

# 1 Setting the scene

## 1.1 Background

As a graphical editor at an international media company, we publish weekly content on digital platforms. This week's theme will focus on "Ship performance".

Our target audience consists of general readers who are interested in the maritime sector and would like to gain insights into shipping performance, profit and loss through data analysis.

## 1.2 Data

The data we used is from Kaggle. This dataset consists of 2,736 observations with 18 attributes.

[**The Ship Performance Dataset**](https://www.kaggle.com/datasets/jeleeladekunlefijabi/ship-performance-clustering-dataset) is a synthetic collection of data including key operational metrics and attributes of various ship types in the Gulf of Guinea. This dataset aims to provide a platform for exploring ship performance trends, identifying patterns, and solving real-world maritime challenges through data-driven approaches.

# 2 Getting Started

## 2.1 Load packages

We load the following R packages using the `pacman::p_load()` function:

::: {.callout-note appearance="simple"}
**p_load()** function allow us to load required packages that are already installed or install it first and then load if not locally available.
:::

```{r}
pacman::p_load(tidyverse, patchwork,
               ggrepel, ggthemes, ggridges, 
               ggdist, ggiraph, plotly, DT,
               hrbrthemes, ggiraph,ggstatsplot)
```

+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| **Library**                                                                                  | **Description**                                                                                                                         |
+==============================================================================================+=========================================================================================================================================+
| [**tidyverse**](https://www.tidyverse.org/)                                                  | A collection of core packages designed for data science.                                                                                |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**patchwork**](https://patchwork.data-imaginist.com/)                                       | Prepare composite figure created using **ggplot2**                                                                                      |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**ggthemes**](https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/)       | Extra themes, geoms, and scales for ggplot2.                                                                                            |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**ggridges**](https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html) | A ggplot2 extension specially designed for plotting ridgeline plots                                                                     |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**gganimate**](https://gganimate.com/)                                                      | An ggplot extension for creating animated statistical graphs.                                                                           |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**ggdist**](https://mjskay.github.io/ggdist/)                                               | A ggplot2 extension spacially desgin for visualising distribution and uncertainty.                                                      |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**plotly**](https://plotly.com/r/)                                                          | R library for plotting interactive statistical graphs.                                                                                  |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**DT**](https://rstudio.github.io/DT/)                                                      | provides an R interface to the JavaScript library [**DataTables**](https://datatables.net/) that create interactive table on html page. |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+
| [**ggiraph**](https://davidgohel.github.io/ggiraph/)                                         | For making ‘ggplot’ graphics interactive.                                                                                               |
+----------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+

## 2.2 Data Import, Overview and Pre-processing

::: panel-tabset
## Data Import

We use **`read_csv()`** of readr to import data and **`datatable()`** of DT to display it:

```{r}
ship <- read_csv("data/Ship_Performance_Dataset.csv")

```

```{r}
#| echo: false
DT::datatable(ship, class= "display",
              caption = "Table 1: Ship Performance Data") %>%
  formatStyle(
    columns = colnames(ship), 
    fontSize = '12px', 
    fontFamily = 'Helvetica', 
    lineHeight = '1.2'
  )
```

## Data Overview

### Check data structure

We use **`str()`** function of R to check the internal structure of the data frame:

```{r}
str(ship)
```

### Check data summary

The code chunk below uses R's **`summary()`** function to display statistical summaries of our data frame.

```{r}
summary(ship)
```

### Check Unique Values for Categorical Attribute

As shown in the data summary above, we have categorical data that I want to examine for unique values. The code below uses **map_chr** from the **purrr** package to map the function across the character vector:

```{r}
# define a function called get_unique_var:
get_unique_var <- function(column) {
  unique_vals <- unique(ship[[column]])
  unique_count <- length(unique_vals)
  paste("Column Name:", column,
         "| Unique Count:", unique_count,
         "| Unique Values:", paste(unique_vals, collapse = ", "))
}

# select specific columns
selected_var <- ship %>% select(Route_Type, Ship_Type, Engine_Type, Maintenance_Status, Weather_Condition)

# apply the function to each column and store the results
unique_var <- map_chr(names(selected_var), get_unique_var)

unique_var
```

## Meta Data

Since the imported data types are not fully correct, we will handle them in the next tab "Data Preprocessing". The data contain 5 categorical attributes, 1 temporal attribute, 11 decimal attributes, and 1 integer attributes:

+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Attribute                   | Data type     | Description                                                                                                                                                                                                   |
+=============================+===============+===============================================================================================================================================================================================================+
| **Date**                    | *Date*        | Timestamp of the data entry from 2023/6/4 to 2024/6/30 (weekly data)                                                                                                                                          |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Ship_Type**               | *Categorical* | Type of ship (e.g., Tanker, Container Ship, Fish Carrier, Bulk Carrier).                                                                                                                                      |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Route_Type**              | *Categorical* | Shipping route type (e.g., Short-haul, Long-haul, Transoceanic).                                                                                                                                              |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Engine_Type**             | *Categorical* | Type of engine (e.g., Diesel, Heavy Fuel Oil).                                                                                                                                                                |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Maintenance_Status**      | *Categorical* | Maintenance condition of the ship (e.g., Fair, Critical, Good).                                                                                                                                               |
|                             |               |                                                                                                                                                                                                               |
|                             |               | -   Level: Good \> Fair \> Critical                                                                                                                                                                           |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Weather_Condition**       | *Categorical* | Prevailing weather conditions during voyages (e.g., Calm, Moderate, Rough)                                                                                                                                    |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Speed_Over_Ground_knots** | *Decimal*     | Average speed of the ship over water (in knots).                                                                                                                                                              |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Engine_Power_kW**         | *Decimal*     | Total weekly Engine power output (in kilowatts).                                                                                                                                                              |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Distance_Traveled_nm**    | *Decimal*     | Total weekly distance traveled by the ship (in nautical miles).                                                                                                                                               |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Draft_meters**            | *Decimal*     | It represents how deep the ship sits in the water and is a key measurement for navigation (in meters).                                                                                                        |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Cargo_Weight_tons**       | *Decimal*     | Total cargo weight per voyage (in tons)                                                                                                                                                                       |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Operational_Cost_USD**    | *Decimal*     | Total operational cost per voyage (in USD).                                                                                                                                                                   |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Revenue_per_Voyage_USD**  | *Decimal*     | Revenue generated per voyage (in USD).                                                                                                                                                                        |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Turnaround_Time_hours**   | *Decimal*     | Total time required to complete all activities necessary for a vessel to be ready for its next journey or task, including docking, unloading packages, refueling and other necessary maintainance (in hours). |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Efficiency_nm_per_kWh**   | *Decimal*     | Measureing how efficiently a vessel uses energy to travel in nautical miles per kilowatt-hour.                                                                                                                |
|                             |               |                                                                                                                                                                                                               |
|                             |               | -   A higher value means the vessel is more energy efficient                                                                                                                                                  |
|                             |               | -   1 nm ≈ 1.852 km                                                                                                                                                                                           |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Seasonal_Impact_Score**   | *Decimal*     | Measures how seasonal factors (e.g., monsoons, winter storms, ice conditions) impact vessel efficiency, turnaround time, or fuel consumption.                                                                 |
|                             |               |                                                                                                                                                                                                               |
|                             |               | -   A higher score indicates greater disruptions due to seasonal changes.                                                                                                                                     |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Weekly_Voyage_Count**     | *Integer*     | The number of voyages a vessel completes within a week.                                                                                                                                                       |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Average_Load_Percentage** | *Decimal*     | The average percentage of capacity utilized by a vessel, vehicle, or transportation system over a week. Average Load Percentage = Actual Cargo Weight / Maximum Capacity \* 100                               |
|                             |               |                                                                                                                                                                                                               |
|                             |               | -   A low percentage may indicate **inefficient routing or underutilized capacity**.                                                                                                                          |
+-----------------------------+---------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

## Data Pre-processing

### Check missing values

As part of data wrangling, we begin by checking for missing values and duplicate records:

```{r}
# check missing value 
any(is.na(ship))
```

Although there are no missing values, but from the observation tab, we can see there are "None"s appearing in the dataset. The result of the code below showing each of the categorical attribute containing 136 "None" values and the related 609 records.

```{r}
# check None value
cat_var <- c('Route_Type', 'Ship_Type', 'Engine_Type', 'Maintenance_Status', 'Weather_Condition')

#check "None" value in cat variables
none_counts <- ship %>%
  select(all_of(cat_var)) %>%
  summarise(across(everything(), ~ sum(. == "None")))
  
none_counts
```

```{r}
#| echo: false

records_with_none <- ship %>%
  filter(if_any(all_of(cat_var), ~ . == "None"))

DT::datatable(records_with_none, class= "display",
              caption = "Table 1: Ship Performance Data") %>%
  formatStyle(
    columns = colnames(ship), 
    fontSize = '12px', 
    fontFamily = 'Helvetica', 
    lineHeight = '1.2'
  )
```

### Check duplicate records

-   **`distinct()`** function of dplyr package is used to identify the unique values within categorical attributes. The dataset contains 2,736 observations, matching the raw data count, which confirms there are no duplicate records.

```{r}
# check duplicate records
distinct(ship)
```

### Convert data type

We then convert the data type for 5 categorical attributes from \<chr\> to \<fctr\> and 1 integer attribute from \<dbl\> to \<int\> by using **`mutate()`** of dplyr package.

```{r}
# mutate data type
ship <- ship %>% 
  mutate_if(is.character, as.factor) %>%
  mutate(Weekly_Voyage_Count = as.integer(Weekly_Voyage_Count))

#check the revised data type
head(ship)

```
:::

# 3 Data Exploration and Data Wrangling

Before variable selection, let's visualize all numeric and categorical data, and see if there's any insight we can get:

## 3.1 Numeric Variables

The numeric variables display multimodal or uniform distributions (particularly for operational cost and revenue) rather than normal distributions. This pattern likely results from different ship types and route types creating distinct peaks in the distribution. Since this dataset contains weekly ship data, with ships making varying numbers of voyages, we should normalize all numeric variables to a per-voyage basis rather than using total amounts like "Distance_Traveled_nm".

Also, we can clearly observe that the scale of ***Operational_Cost_USD*** and ***Revenue_per_Voyage_USD*** have different scale comparing to others, which need further adjusted.

::: toggle
<details>

<summary>**Display Code**</summary>

``` r
# select numeric variables
ship_numeric <- ship %>% select_if(is.numeric)

# unpivot the data from wide to long format
ship_long <- ship_numeric %>% 
  pivot_longer(cols = everything(), # select all num variables
               names_to = "variable", 
               values_to = "value")

# Plot histograms for all numeric variables with facets
ggplot(ship_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "grey70", color = "grey30") +
  facet_wrap(~ variable, scales = "free") +
  labs(title = "Histograms of All Numeric Variables",
       x = "", y = "Frequency") +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        panel.grid = element_blank())
```

</details>
:::

```{r}
#| echo: false

# select numeric variables
ship_numeric <- ship %>% select_if(is.numeric)

# unpivot the data from wide to long format
ship_long <- ship_numeric %>% 
  pivot_longer(cols = everything(), # select all num variables
               names_to = "variable", 
               values_to = "value")

# Plot histograms for all numeric variables with facets
ggplot(ship_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "grey70", color = "grey30") +
  facet_wrap(~ variable, scales = "free") +
  labs(title = "Histograms of All Numeric Variables",
       x = "", y = "Frequency") +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        panel.grid = element_blank(),
        )
```

## 3.2 Categorical Variables

To understand the marine sector, we need to research and understand the characteristics of different ship types, engine types, and route types for better analysis:

### 3.2.1 Ship Type

-   **Bulk Carrier**: Carry dry raw mateials like coal, grain and iron ore. The cargo normally holds with hatch covers with large quantity, following long-haul trade routes

-   **Container Ship**: Carry standardized constainers, designed with flat deck with container slots and securing mechanisms. It's suitable for efficient global trade.

-   **Fish Carrier**: It is used to ship live or frozen fish from fishing vessels to processing facilities or markets, equipped with water tanks (for live fish) or refrigerated holds (for frozen fish)

-   **Taker**: Carry liquid cargo like crude oil and petroleum products, equipped with large cylindrical tanks, reinforced hulls, following strict environmental regulations.

### 3.2.2 Route Type

Based on ship distance: **Transoceanic Routes\>Long-Haul Routes\>Short-Haul Routes\>Coastal Routes**

-   **Coastal Routes**: Ships operate **close to the coast** or within a specific region, often moving between ports in the same country or nearby nations. Normally focus on frequent trips rather than high cargo volume.

-   **Short-Haul Routes:** Routes that connect **medium-distance** destinations (typically within a continent or between neighboring regions). Medium-sized vessels for balanced capacity and speed.

-   **Long-Haul Routes:** Ships travel **between continents(international trade)**, connecting major industrial and commercial centers. Larger ships designed for fuel efficiency and maximum cargo capacity.

-   **Transoceanic Routes:** Ships cross **entire oceans(Global Trade)**, linking distant global markets (e.g., Asia to Europe, North America to Australia). **Largest** ships with ultra-long-range fuel capacity.

### 3.2.3 Engine Type

**Fuel efficeincy: Diesel \> HFO \> Stream Turbine**

-   **Heavy Fuel Oil (HFO) Engines**: These engines use **Heavy Fuel Oil (HFO)**, which is a low-cost but highly polluting fuel, common **in large commercial ships and long-haul or** **Transoceanic Routes** due to cost efficiency.

-   **Steam Turbine Engines**: These engines uses **steam to drive a turbine**, typically powered by **boilers burning HFO or LNG.** Ships with these engines supposed to be aged, for its a technology old goods. It is less fuel-efficient compared to diesel engines.

-   Diesel Engines: It is the **most common** engine type today, which is **more fuel-efficient** and meets modern environmental regulations.

### 3.2.4 Visualization

As for categorical variables, the distributions are also quite even, except for:

-   The number of ship with **diesel engines** is slightly higher than others

-   The count of **long-haul** slightly higher

-   The count of "rough" weather condition is slightly lower than others

::: toggle
<details>

<summary>**Display Code**</summary>

``` r
# select only char variables
ship_factors <- ship %>% select_if(is.factor)  

# unpivot the data from wide to long format
ship_long_factors <- ship_factors %>% 
  pivot_longer(cols = everything(), 
               names_to = "variable", 
               values_to = "value")


# plot bar charts for all categorical variables
ggplot(ship_long_factors, aes(x = value, fill = variable)) +
  geom_bar() +
  facet_wrap(~ variable, scales = "free") +  # Facet by variable name
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Bar Plots of All Categorical Variables",
       x = "", y = "Count") +
  theme_minimal() +
    theme(plot.title = element_text(size=13, hjust=0),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        legend.position = "none",
        axis.text.x = element_text(angle=20, hjust=1, size= 7),
        axis.text.y = element_text(size=6),
        panel.grid = element_blank())
```

</details>
:::

```{r}
#| echo: false


# select only char variables
ship_factors <- ship %>% select_if(is.factor)  

# unpivot the data from wide to long format
ship_long_factors <- ship_factors %>% 
  pivot_longer(cols = everything(), 
               names_to = "variable", 
               values_to = "value")

# customized palette
my_palette <- c("#D989AE99", "#96C6D999", "#F2CD8899", "#D9725B99", "#468C6C99", "grey60")


# plot bar charts for all categorical variables
ggplot(ship_long_factors, aes(x = value, fill = variable)) +
  geom_bar() +
  facet_wrap(~ variable, scales = "free") +  # Facet by variable name
  scale_fill_manual(values = my_palette) +
  labs(title = "Bar Plots of All Categorical Variables",
       x = "", y = "Count") +
  theme_minimal() +
    theme(plot.title = element_text(size=13, hjust=0),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        legend.position = "none",
        axis.text.x = element_text(angle=20, hjust=1, size= 7),
        axis.text.y = element_text(size=6),
        panel.grid = element_blank())


```

## 3.3 Data Wrangling

After checking all variables, I identified several of them that need to be derived, transformed, or dropped:

### 3.3.1 Transform Data Unit

-   **Operational_Cost_USD** & **Revenue_per_Voyage_USD**: Both variables are in USD, we should divide them by 1,000 to make them more comparable

```{r}

# divide Operational cost and revenue by 1000

ship_cleaned <- ship %>%
  mutate(Cost_per_Voyage_k = Operational_Cost_USD/1000)

ship_cleaned <- ship_cleaned %>%
  mutate(Revenue_per_Voyage_k = Revenue_per_Voyage_USD/1000)


```

### 3.3.2 Derive New Variables

-   **Date**: Weekly data is too granular for our analysis, so "**New_Date**" variable is created for monthly data and derive "**Season**" variables from the Date field.

    ```{r}
    # create New_date (monthly)
    ship_cleaned <- ship_cleaned %>%
      mutate(New_Date = as.Date(paste(format(Date, "%Y"),
                                      format(Date, "%m"), "01", sep = "-"), format = "%Y-%m-%d"))
    # create season var
    ship_cleaned <- ship_cleaned %>%
      mutate(Quarter = case_when(
        month(Date) %in% 1:3 ~ "Q1",
        month(Date) %in% 4:6 ~ "Q2",
        month(Date) %in% 7:9 ~ "Q3",
        month(Date) %in% 10:12 ~ "Q4"
      ))
    ```

-   **Profit and Net Margin Per Voyage:** Profit and Net margin percentage per voyage will be calculated to evaluate ship financial performance.

    ```{r}
    # create profit per voyage
    ship_cleaned <- ship_cleaned %>%
      mutate(Net_margin_per_Voyage = ((Revenue_per_Voyage_k - Cost_per_Voyage_k) / Revenue_per_Voyage_k) * 100)

    # create profit per voyage
    ship_cleaned <- ship_cleaned %>%
      mutate(Net_profit_per_Voyage = Revenue_per_Voyage_k - Cost_per_Voyage_k)
    ```

-   **Distance travel & Engine_Power_kW** **per Voyage**:According to Kaggle, "**Engine_Power_kW**" and "**Distance_Traveled_nm**" represent total engine power and distance traveled by the ship. These values will be divided by weekly_voyage_count.

    ```{r}
    # create distance travel per voyage
    ship_cleaned <- ship_cleaned %>%
      mutate(distance_travel_per_V = Distance_Traveled_nm / Weekly_Voyage_Count)

    # create Engine_Power_kW per voyage
    ship_cleaned <- ship_cleaned %>%
      mutate(Engine_Power_kW_per_V = Engine_Power_kW / Weekly_Voyage_Count)
    ```

-   **Maximum Capacity of Ships and Classification:** The original dataset lacks ship size information. This is a significant factor for shipment capacity and directly affects potential revenue and operational cost per voyage.

    ```{r}
    # create Maxiumn Capacity of ship
    ship_cleaned <- ship_cleaned %>%
      mutate(Max_capacity = Cargo_Weight_tons / Average_Load_Percentage*100)

    # categorized ship into diff size based on max capacity
    ship_cleaned$Ship_Size <- cut(ship_cleaned$Max_capacity, 
                        breaks = c(0, 800, 1600, 2400, 3200, Inf), 
                        labels = c("Very Small", "Small", "Medium", "Large", "Very Large"), 
                        right = FALSE)
    # create interaction variables - ship type * ship size * engine type
    ship_cleaned <- ship_cleaned %>%
      mutate(
        ship_engine_size = factor(interaction(Ship_Type, Engine_Type,Ship_Size, sep = "_")))
    ```

### 3.3.3 Drop Variables and None Values

Based on the previous univariate and correlation analysis, we will retain only the relevant variables for further analysis. Though missing values in Categorical data didn't affect much, but it's quite annoying when visualization, since all catgorical data include missing values

```{r}
# These variables are dropped
ship_cleaned <- ship_cleaned %>% select(-c(
     'Operational_Cost_USD','Revenue_per_Voyage_USD',
     'Draft_meters','Speed_Over_Ground_knots','Engine_Power_kW',
     'Distance_Traveled_nm','Date','Draft_meters',
     'Speed_Over_Ground_knots'))

# filter all the cat data is not "None"
ship_cleaned <- ship_cleaned %>%
  filter(if_all(all_of(cat_var), ~ . != "None"))

```

### 3.3.5 Check Correlation Matrix

We then use `ggcorrmat`examine the correlation matrix of numerical variables.

Based on the results below, only five pairs of variables show significant correlations:

-   Net_margin_per_Voyage vs Revenue_per_Voyage (r=0.59)

-   Net_margin_per_Voyage vs Cost_per_Voyage (r=-0.43)

-   Engine_Power_kW_per_V vs distance_travel_per_V (r=0.65)

-   Weekly_voyage_count vs Engine_Power_kW_per_V (r=-0.69)

-   Weekly_voyage_count vs distance travel_per_V (r=-0.62)

These correlations indicate that Net margin increases with higher Revenue and decreases with higher Cost. Ships traveling longer distances tend to use more engine power with fewer voyage.

::: toggle
<details>

<summary>**Display Code**</summary>

``` r
ship_cleaned_num <- ship_cleaned %>% select_if(is.numeric) 

ggcorrmat(
  data = ship_cleaned_num, 
  ggcorrplot.args = list(outline.color = "black", 
                         hc.order = TRUE,
                         tl.cex = 8),
  title    = "Correlogram for ship dataset",
  subtitle = "None of pairs is significant at p < 0.05")+
  theme(plot.title = element_text(size=13, hjust=0),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        axis.text.x = element_text(angle=30, hjust=1, size= 7),
        axis.text.y = element_text(size=7),
        panel.grid = element_blank())
```

</details>
:::

```{r}
#| echo: false
ship_cleaned_num <- ship_cleaned %>% select_if(is.numeric) 

ggcorrmat(
  data = ship_cleaned_num, 
  ggcorrplot.args = list(outline.color = "black", 
                         hc.order = TRUE,
                         tl.cex = 8),
  title    = "Correlogram for ship dataset",
  subtitle = "None of pairs is significant at p < 0.05")+
  theme(plot.title = element_text(size=13, hjust=0),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        axis.text.x = element_text(angle=30, hjust=1, size= 7),
        axis.text.y = element_text(size=7),
        panel.grid = element_blank(),
        plot.margin = margin(t = 15, r = 50, b = 15, l = 50, unit = "pt") )
  
```

### 3.3.4 Check Variable Distribution and Summary After Data Wrangling

After transformation, Net_profit_per_Voyage shows a normal distribution. However, Net_margin_per_Voyage displays extreme values—ranging from -842.56% to 98.73%, with a median of 50.56%—indicating substantial variation in profit margins across ships.

::::: panel-tabset
## Numerical Data Distribution

::: toggle
<details>

<summary>**Display Code**</summary>

``` r
# select numeric variables
ship_cleaned_num<- ship_cleaned %>% select_if(is.numeric)

# unpivot the data from wide to long format
ship_long <- ship_cleaned_num %>% 
  pivot_longer(cols = everything(), # select all num variables
               names_to = "variable", 
               values_to = "value")

# Plot histograms for all numeric variables with facets
ggplot(ship_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "grey70", color = "grey30") +
  facet_wrap(~ variable, scales = "free") +
  labs(title = "Histograms of All Numeric Variables",
       x = "", y = "Frequency") +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        panel.grid = element_blank(),
        )
```

</details>
:::

```{r}
#| echo: false

# select numeric variables
ship_cleaned_num<- ship_cleaned %>% select_if(is.numeric)

# unpivot the data from wide to long format
ship_long <- ship_cleaned_num %>% 
  pivot_longer(cols = everything(), # select all num variables
               names_to = "variable", 
               values_to = "value")

# Plot histograms for all numeric variables with facets
ggplot(ship_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "grey70", color = "grey30") +
  facet_wrap(~ variable, scales = "free") +
  labs(title = "Histograms of All Numeric Variables",
       x = "", y = "Frequency") +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        panel.grid = element_blank(),
        )


```

## Categorical Data Distribution

```{r}
ship_factors <- ship_cleaned %>% select_if(is.factor)  

# unpivot the data from wide to long format
ship_long_factors <- ship_factors %>% 
  pivot_longer(cols = everything(), 
               names_to = "variable", 
               values_to = "value")


# plot bar charts for all categorical variables
ggplot(ship_long_factors, aes(x = value, fill = variable)) +
  geom_bar() +
  facet_wrap(~ variable, scales = "free") +  # Facet by variable name
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Bar Plots of All Categorical Variables",
       x = "", y = "Count") +
  theme_minimal() +
    theme(plot.title = element_text(size=13, hjust=0),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA),
        legend.position = "none",
        axis.text.x = element_text(angle=20, hjust=1, size= 7),
        axis.text.y = element_text(size=6),
        panel.grid = element_blank())
```

::: panel-tabset
## New Summary

```{r}
summary(ship_cleaned)
```
:::
:::::

# 4 Insights

## 4.1 Exploring Average Revenue and Net Margin Across Ship Types

The interactive below shows the average revenue and net margin Rate over time. We can see the average of reve

::: toggle
<details>

<summary>**Display Code**</summary>

``` r

# calculate average revenue, cost, and profit margin per Ship_Type over time
ship_avg <- ship_cleaned %>%
  group_by(New_Date, Ship_Type) %>%
  summarize(
    avg_revenue = mean(Revenue_per_Voyage_k, na.rm = TRUE),
    avg_cost = mean(Cost_per_Voyage_k, na.rm = TRUE),
    avg_impact = mean(Seasonal_Impact_Score, na.rm = TRUE),
    avg_load = mean(Average_Load_Percentage,a.rm = TRUE))%>%
  mutate(avg_profit_margin = (avg_revenue - avg_cost) / avg_revenue * 100)

# calculate all ship's average revenue, cost, and profit margin over time
avg <- ship_cleaned %>%
  group_by(New_Date) %>%
  summarize(
    avg_revenue = mean(Revenue_per_Voyage_k, na.rm = TRUE),
    avg_cost = mean(Cost_per_Voyage_k, na.rm = TRUE),
    avg_impact = mean(Seasonal_Impact_Score, na.rm = TRUE),
    avg_load = mean(Average_Load_Percentage,a.rm = TRUE))%>%

  mutate(avg_profit_margin = (avg_revenue - avg_cost) / avg_revenue * 100)


# compute yearly average per Ship_Type
yearly_avg <- ship_cleaned %>%
  group_by(Ship_Type) %>%
  summarize(
    avg_revenue = mean(Revenue_per_Voyage_k, na.rm = TRUE),
    avg_profit_margin = mean((Revenue_per_Voyage_k - Cost_per_Voyage_k) / Revenue_per_Voyage_k * 100, na.rm = TRUE)
  )

ship_avg <- ship_avg %>%
  left_join(yearly_avg, by = "Ship_Type", suffix = c("", "_yearly"))


# plot avg rev by ship type
p1 <- ggplot() + 
  geom_line_interactive(data = ship_avg, 
                        aes(x = New_Date, 
                            y = avg_revenue,
                            color = Ship_Type, 
                            tooltip = round(avg_revenue_yearly,2),
                            data_id = Ship_Type), size = 1) +
  geom_line(data = avg, 
            aes(x = New_Date, y = avg_revenue), 
            size = 0.8, 
            linetype = "dashed", 
            color='grey40') +
  scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y")+
  scale_color_manual(values = my_palette)+
  labs(x = "",
       y = "Revenue per Voyage ($000s)",
       title = "Exploring Average Revenue and Net Margin Across Ship Types",
       color = "Legend") +
  theme_classic() +
  theme(plot.title = element_text(size=12, hjust=0,face='bold'),
        axis.title.y = element_text(size=7),
        axis.text = element_text(size = 6),
        legend.position = 'top',
        legend.background = element_rect(fill = "#f3f1e9"),
        legend.key.size = unit(0.2,"cm"),
        legend.title = element_text(size=9),
        legend.text = element_text(size=8),
        panel.grid= element_line(color='grey60',size=0.1),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA))


# plot avg profit margin by ship type

p2 <- ggplot() + 
  geom_line_interactive(data = ship_avg, 
                        aes(x = New_Date, y = avg_profit_margin,
                            color = Ship_Type,tooltip = round(avg_profit_margin_yearly,2),
                            data_id = Ship_Type), size = 1) +
  geom_line(data = avg, aes(x = New_Date, y = avg_profit_margin),
            size = 0.8, linetype = "dashed", color='grey40') + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y")+
  scale_color_manual(values = my_palette)+
  labs(x = "",
       y = "Profit Margin %",
       color = "Legend") +
  theme_classic() +
  theme(
        axis.title.y = element_text(size=7),
        axis.text = element_text(size = 6),
        legend.position = 'none',
        legend.justification = c(0, 1),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        panel.grid= element_line(color='grey60',size=0.1),
        plot.background = element_rect(fill = "#f3f1e9",color = NA))


# combine two plots
patch <- p1/p2  &
  theme(
    plot.margin = margin(0, 0, 0, 0),  # Removes extra space around the combined plots
    plot.background = element_rect(fill = "#f3f1e9", color = NA) 
  )

# giraffe interactive graph
girafe(
  code = print(patch), 
  width_svg = 6,
  height_svg = 4,
  options = list(
    opts_hover(css = "stroke-width:3px; opacity: 1;"),
    opts_hover_inv(css = "opacity: 0.2;")
  ))
```

</details>
:::

```{r}
#| echo: false
#| fig-height: 6
#| fig-width: 12
#| out-extra: "style='max-width:100%; display: block;'"
#| out-width: 100%

# calculate average revenue, cost, and profit margin per Ship_Type over time
ship_avg <- ship_cleaned %>%
  group_by(New_Date, Ship_Type) %>%
  summarize(
    avg_revenue = mean(Revenue_per_Voyage_k, na.rm = TRUE),
    avg_cost = mean(Cost_per_Voyage_k, na.rm = TRUE),
    avg_impact = mean(Seasonal_Impact_Score, na.rm = TRUE),
    avg_load = mean(Average_Load_Percentage,a.rm = TRUE))%>%
  mutate(avg_profit_margin = (avg_revenue - avg_cost) / avg_revenue * 100)

# calculate all ship's average revenue, cost, and profit margin over time
avg <- ship_cleaned %>%
  group_by(New_Date) %>%
  summarize(
    avg_revenue = mean(Revenue_per_Voyage_k, na.rm = TRUE),
    avg_cost = mean(Cost_per_Voyage_k, na.rm = TRUE),
    avg_impact = mean(Seasonal_Impact_Score, na.rm = TRUE),
    avg_load = mean(Average_Load_Percentage,a.rm = TRUE))%>%

  mutate(avg_profit_margin = (avg_revenue - avg_cost) / avg_revenue * 100)


# compute yearly average per Ship_Type
yearly_avg <- ship_cleaned %>%
  group_by(Ship_Type) %>%
  summarize(
    avg_revenue = mean(Revenue_per_Voyage_k, na.rm = TRUE),
    avg_profit_margin = mean((Revenue_per_Voyage_k - Cost_per_Voyage_k) / Revenue_per_Voyage_k * 100, na.rm = TRUE)
  )

ship_avg <- ship_avg %>%
  left_join(yearly_avg, by = "Ship_Type", suffix = c("", "_yearly"))


# plot avg rev by ship type
p1 <- ggplot() + 
  geom_line_interactive(data = ship_avg, 
                        aes(x = New_Date, 
                            y = avg_revenue,
                            color = Ship_Type, 
                            tooltip = round(avg_revenue_yearly,2),
                            data_id = Ship_Type), size = 1) +
  geom_line(data = avg, 
            aes(x = New_Date, y = avg_revenue), 
            size = 0.8, 
            linetype = "dashed", 
            color='grey40') +
  scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y")+
  scale_color_manual(values = my_palette)+
  labs(x = "",
       y = "Revenue per Voyage ($000s)",
       title = "Exploring Average Revenue and Net Margin Across Ship Types",
       color = "Legend") +
  theme_classic() +
  theme(plot.title = element_text(size=11, hjust=0.5,face='bold'),
        axis.title.y = element_text(size=7),
        axis.text = element_text(size = 6),
        legend.position = 'top',
        legend.background = element_rect(fill = "#f3f1e9"),
        legend.key.size = unit(0.2,"cm"),
        legend.title = element_text(size=9),
        legend.text = element_text(size=8),
        panel.grid= element_line(color='grey60',size=0.1),
        panel.background = element_rect(fill = "#f3f1e9"),
        plot.background = element_rect(fill = "#f3f1e9",color = NA))


# plot avg profit margin by ship type

p2 <- ggplot() + 
  geom_line_interactive(data = ship_avg, 
                        aes(x = New_Date, y = avg_profit_margin,
                            color = Ship_Type,tooltip = round(avg_profit_margin_yearly,2),
                            data_id = Ship_Type), size = 1) +
  geom_line(data = avg, aes(x = New_Date, y = avg_profit_margin),
            size = 0.8, linetype = "dashed", color='grey40') + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b\n%Y")+
  scale_color_manual(values = my_palette)+
  labs(x = "",
       y = "Profit Margin %",
       color = "Legend") +
  theme_classic() +
  theme(
        axis.title.y = element_text(size=7),
        axis.text = element_text(size = 6),
        legend.position = 'none',
        legend.justification = c(0, 1),
        legend.background = element_rect(fill = "#f3f1e9"),
        panel.background = element_rect(fill = "#f3f1e9"),
        panel.grid= element_line(color='grey60',size=0.1),
        plot.background = element_rect(fill = "#f3f1e9",color = NA))


# combine two plots
patch <- p1/p2  &
  theme(
    plot.margin = margin(0, 0, 0, 0),  # Removes extra space around the combined plots
    plot.background = element_rect(fill = "#f3f1e9", color = NA) 
  )

# giraffe interactive graph
girafe(
  code = print(patch), 
  width_svg = 6,
  height_svg = 4,
  options = list(
    opts_hover(css = "stroke-width:3px; opacity: 1;"),
    opts_hover_inv(css = "opacity: 0.2;")
  ))
```

## 4.2 Seasonal Profit Trends by Ship Type: A Closer Look

::: toggle
<details>

<summary>**Display Code**</summary>

``` r
# calculate average profit per quarter

quarter_avg <- ship_cleaned %>%
  group_by(Quarter) %>%
  summarise(avg_profit = mean(Net_profit_per_Voyage, na.rm = TRUE))


            
ggplot(ship_cleaned, aes(x = Net_profit_per_Voyage, 
                              y = interaction(Route_Type, Engine_Type, Ship_Type),
                              fill = Ship_Type)) +  
  geom_boxplot(outlier.shape = 16, 
               outlier.colour = "black",  
               outlier.size = 0.5,
               position = position_dodge(width = 0.7)) +  
  scale_fill_manual(values = my_palette) +
  # set facet title order
  facet_wrap(~ factor(Quarter, levels = c("Q1", "Q2", "Q3", "Q4")), ncol = 4) +
  theme_classic() +  
  labs(title = "Quarter Profit Trends by Ship Type: A Closer Look",
       x = "Net Profit ('000 USD)", 
       y = "Route, Engine & Ship Type") +
  theme(
    axis.text.y = element_text(size = 6), 
    axis.text.x = element_text(size = 6),  
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    strip.text = element_text(size = 7, face = "bold"),  # Facet title size
    legend.position = "top",
    legend.title = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size = 6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.background = element_rect(fill = "#f3f1e9", color = NA),
    plot.title = element_text(size = 12,hjust = 0.5,face='bold'),
    plot.margin = margin(10, 50, 10 ,20), 
    panel.spacing = unit(1, "lines"),
    strip.placement = "outside",  # Places strip above the panel
    strip.switch.pad.wrap = unit(1, "cm") 
  )+
  geom_vline(data = quarter_avg, 
             aes(xintercept = avg_profit), 
             color = "white", linetype = "dashed", size = 0.4)
```

</details>
:::

```{r}
#| echo: false


# calculate average profit per quarter
quarter_avg <- ship_cleaned %>%
  group_by(Quarter) %>%
  summarise(avg_profit = mean(Net_profit_per_Voyage, na.rm = TRUE))


            
ggplot(ship_cleaned, aes(x = Net_profit_per_Voyage, 
                              y = interaction(Route_Type, Engine_Type, Ship_Type),
                              fill = Ship_Type)) +   
  geom_boxplot(outlier.shape = 16, 
               outlier.colour = "black",  
               outlier.size = 0.5,
               position = position_dodge(width = 0.7)) +  
  scale_fill_manual(values = my_palette) +
  # set facet title order
  facet_wrap(~ factor(Quarter, levels = c("Q1", "Q2", "Q3", "Q4")), ncol = 4) +
  theme_classic() +  
  labs(title = "Seasonal Profit Trends by Ship Type: A Closer Look",
       x = "Net Profit ('000 USD)", 
       y = "Route, Engine & Ship Type") +
  theme(
    axis.text.y = element_text(size = 6), 
    axis.text.x = element_text(size = 6),  
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    strip.text = element_text(size = 7, face = "bold"),  # Facet title size
    legend.position = "top",
    legend.title = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size = 6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.background = element_rect(fill = "#f3f1e9", color = NA),
    plot.title = element_text(size = 15,hjust = 0.5,face='bold'),
    plot.margin = margin(10, 50, 10 ,20), 
    panel.spacing = unit(1, "lines"),
    strip.placement = "outside",  # Places strip above the panel
    strip.switch.pad.wrap = unit(1, "cm") 
  )+
  geom_vline(data = quarter_avg, 
             aes(xintercept = avg_profit), 
             color = "white", linetype = "dashed", size = 0.4)
```

::: panel-tabset
## Normality Test

```{r}
shapiro.test(ship_cleaned$Net_profit_per_Voyage)
```

## Kruskal-Wallis test

-   Test

```{r}
# Kruskal-Wallis test with both Route_Type and Ship_Type}
kruskal_test_engine <- kruskal.test(Net_profit_per_Voyage ~ Engine_Type, data = ship_cleaned)
kruskal_test_ship <- kruskal.test(Net_profit_per_Voyage ~ Ship_Type, data = ship_cleaned)
kruskal_test_route <- kruskal.test(Net_profit_per_Voyage ~ Route_Type, data = ship_cleaned)

# Create a new interaction factor
ship_cleaned$Interaction_profit <- interaction(ship_cleaned$Ship_Type, ship_cleaned$Engine_Type,ship_cleaned$Route_Type)

# Kruskal-Wallis test on the interaction factor
kruskal_interaction_profit <- kruskal.test(Net_profit_per_Voyage ~ Interaction_profit, data = ship_cleaned)

print(kruskal_test_engine)
print(kruskal_test_ship)
print(kruskal_test_route)
print(kruskal_interaction_profit)
```
:::

## 4.3 Does Maintenance x Engine Type Influence Cost?

::: toggle
<details>

<summary>**Display Code**</summary>

```         
# Create the plot
ggplot(ship_cleaned, aes(x = Cost_per_Voyage_k, 
                                  y =  Maintenance_Status,
                                  fill = Engine_Type)) +   
  geom_density_ridges(geom = "density_ridges_gradient", 
                      calc_ecdf = TRUE,
                      quantiles = 4,
                      alpha = 0.6,
                      scale = 0.8) +
  geom_boxplot(aes(x = Cost_per_Voyage_k), 
               width = 0.2, 
               position = position_dodge(width = 0.8), 
               alpha = 0.6,
               outliers = TRUE) +
  coord_flip()+
  scale_fill_manual(values = my_palette) +
  facet_grid(~Engine_Type)+
  theme_ridges() +
  labs(title = "Does Maintenance x Engine Type Influence Cost?",
       subtitle = "Yes, it does affect. The Kruskal-Wallis tests show there's an interaction effect (p-value = 0.001) \nbetween Maintenance Status and Engine Type on Operational Cost.",
       x="Maintenance\n Status" ,
       y="Operational Cost ('000USD)")+
  theme(
    axis.text.y = element_text(size = 6), 
    axis.text.x = element_text(size = 6),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"),  # Facet title size
    plot.margin = margin(10, 20, 10, 20),  
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=13,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )
    
```

</details>
:::

```{r}
#| echo: false



# Create the plot
p <- ggplot(ship_cleaned, aes(x = Cost_per_Voyage_k, 
                                  y =  Maintenance_Status,
                                  fill = Engine_Type)) +   
  geom_density_ridges(geom = "density_ridges_gradient", 
                      calc_ecdf = TRUE,
                      quantiles = 4,
                      alpha = 0.6,
                      scale = 0.8) +
  geom_boxplot(aes(x = Cost_per_Voyage_k), 
               width = 0.2, 
               position = position_dodge(width = 0.8), 
               alpha = 0.6,
               outliers = TRUE) +
  coord_flip()+
  scale_fill_manual(values = my_palette) +
  facet_grid(~Engine_Type)+
  theme_ridges() +
  labs(title = "Does Maintenance x Engine Type Influence Cost?",
       subtitle = "Yes, it does affect. The Kruskal-Wallis tests show there's an interaction effect (p-value = 0.001) \nbetween Maintenance Status and Engine Type on Operational Cost.",
       x="Maintenance\n Status" ,
       y="Operational Cost ('000USD)")+
  theme(
    axis.text.y = element_text(size = 7), 
    axis.text.x = element_text(size = 7),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"),  # Facet title size
    plot.margin = margin(10, 20, 10, 20),  
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=13,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )
    


plot(p)
```

::: panel-tabset
## Normality Test

```{r}
shapiro.test(ship_cleaned$Cost_per_Voyage_k)
```

## Kruskal-Wallis Test

```{r}
# Kruskal-Wallis test with both Route_Type and Ship_Type
kruskal_test_engine <- kruskal.test(Cost_per_Voyage_k ~ Engine_Type, data = ship_cleaned)
kruskal_test_maintain <- kruskal.test(Cost_per_Voyage_k ~ Maintenance_Status, data = ship_cleaned)

# Create a new interaction factor
ship_cleaned$Interaction <- interaction(ship_cleaned$Maintenance_Status, ship_cleaned$Engine_Type)

# Kruskal-Wallis test on the interaction factor
kruskal_interaction <- kruskal.test(Cost_per_Voyage_k ~ Interaction, data = ship_cleaned)

print(kruskal_test_engine)
print(kruskal_test_maintain)
print(kruskal_interaction)
```
:::

## 4.4 Which Ship & Route Types Have the Most Turnaround Time

::: toggle
<details>

<summary>**Display Code**</summary>

```         
# reorder factor level
ship_cleaned$Route_Type <- factor(ship_cleaned$Route_Type, 
                                  levels = c("Coastal", "Short-haul",
                                             "Long-haul", "Transoceanic"))

ggplot(ship_cleaned, aes(x = Turnaround_Time_hours,
                          y = Route_Type,
                          fill = Ship_Type,
                          color = Ship_Type)) +   
  geom_boxplot(aes(x = Turnaround_Time_hours), 
               width = 0.2, 
               position = position_dodge(width = 1), 
               alpha = 0.6,
               outliers = TRUE) +
  stat_dots(
            side = "left",
            justification = 1.2, 
            binwidth = NA,
            dotsize = 1
            )+
  coord_flip()+
  scale_fill_manual(values = my_palette) +
  facet_wrap(~Ship_Type)+
  theme_ridges() +
  labs(title = "Which Ship & Route Types Have the Most Turnaround Time?",
       subtitle = "",
       x="Turnaround Time\n(Hours)" ,
       y="Route Type")+
  theme(
    axis.text.y = element_text(size = 6), 
    axis.text.x = element_text(size = 6),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"), # Facet title size
    plot.margin = margin(10, 20, 10, 20),  
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=12,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )
```

</details>
:::

```{r}
#| echo: false

# reorder factor level
ship_cleaned$Route_Type <- factor(ship_cleaned$Route_Type, 
                                  levels = c("Coastal", "Short-haul",
                                             "Long-haul", "Transoceanic"))

p <- ggplot(ship_cleaned, aes(x = Turnaround_Time_hours, 
                                  y = Route_Type,
                                  fill = Ship_Type,
                              color = Ship_Type)) +   
  geom_boxplot(aes(x = Turnaround_Time_hours), 
               width = 0.2, 
               position = position_dodge(width = 1), 
               alpha = 0.6,
               outliers = TRUE) +
  stat_dots(
            side = "left",
            justification = 1.2, 
            binwidth = NA,
            dotsize = 1
            )+
  coord_flip()+
  scale_fill_manual(values = my_palette) +
  facet_wrap(~Ship_Type)+
  theme_ridges() +
  labs(title = "Which Ship and Route Types Have the Most Turnaround Time?",
       subtitle = "",
       x="Turnaround Time\n(Hours)" ,
       y="Route Type")+
  theme(
    axis.text.y = element_text(size = 7), 
    axis.text.x = element_text(size = 7),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"), # Facet title size
    plot.margin = margin(10, 20, 10, 20),  
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=12,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )
    


plot(p)
```

::: panel-tabset
## Normality Test

```{r}
shapiro.test(ship_cleaned$Turnaround_Time_hours)
```

## Kruskal-Wallis Test

```{r}
# Kruskal-Wallis test with both Route_Type and Ship_Type
kruskal_test_route <- kruskal.test(Turnaround_Time_hours ~ Route_Type, data = ship_cleaned)
kruskal_test_ship <- kruskal.test(Turnaround_Time_hours ~ Ship_Type, data = ship_cleaned)

# Create a new interaction factor
ship_cleaned$interaction_factor <- interaction(ship_cleaned$Route_Type, ship_cleaned$Ship_Type)

# Kruskal-Wallis test on the interaction factor
kruskal_interaction <- kruskal.test(Turnaround_Time_hours ~ interaction_factor, data = ship_cleaned)

print(kruskal_test_route)
print(kruskal_test_ship)
print(kruskal_interaction)
```
:::

## 4.5 Sailing Towards Profit: Which Ship Types Lead the Way?

```{r}
#| echo: false
#| fig-height: 6
#| fig-width: 12
#| out-extra: "style='max-width:100%; display: block;'"
#| out-width: 100%

# rev, profit, cost
ship_analysis <- ship_cleaned %>%
  group_by(ship_engine_size, New_Date) %>%
  summarise(
    total_revenue = sum(Revenue_per_Voyage_k, na.rm = TRUE),
    total_cost = sum(Cost_per_Voyage_k, na.rm = TRUE),
    total_profit = sum(Net_profit_per_Voyage, na.rm = TRUE),
    .groups = "drop"  # Ensures output is ungrouped
  ) %>%
  arrange(ship_engine_size, New_Date) %>%  # Ensure sorted by ship_engine_size & month
  group_by(ship_engine_size) %>%  # Group again for growth rate calculation
  mutate(
    revenue_growth = (total_revenue - lag(total_revenue)) / lag(total_revenue),
    cost_growth = (total_cost - lag(total_cost)) / lag(total_cost),
    profit_growth = (total_profit - lag(total_profit)) / lag(total_profit),
    profit_margin = (total_profit / total_revenue)
  ) %>%
  ungroup()  # Keep all previous calculations

# cagr
cagr_analysis <- ship_analysis %>%
  group_by(ship_engine_size) %>%
  summarise(
    first_revenue = first(total_revenue),
    last_revenue = last(total_revenue),
    first_cost = first(total_cost),
    last_cost = last(total_cost),
    first_profit = first(total_profit),
    last_profit = last(total_profit),
    months = n(),  # Count the number of months
    revenue_CAGR = (last_revenue / first_revenue)^(1 / months) - 1,
    cost_CAGR = (last_cost / first_cost)^(1 / months) - 1,
    profit_CAGR = (last_profit / first_profit)^(1 / months) - 1,
    .groups = "drop"
  )

#combine two analysis table
ship_analysis <- left_join(ship_analysis, cagr_analysis, by = "ship_engine_size")

# Create a summary dataframe for total revenue per ship_engine
ship_summary <- ship_analysis %>%
  group_by(ship_engine_size) %>%
  summarise(total_revenue_all = mean(total_revenue, na.rm = TRUE)) %>%
  arrange(total_revenue_all)

# Create the long format dataframe for rev & p
ship_PnL <- ship_analysis %>%
    group_by(ship_engine_size) %>%
    summarise(
        avg_revenue = mean(total_revenue, na.rm = TRUE),
        avg_profit = mean(total_profit, na.rm = TRUE)
    ) %>%
    pivot_longer(cols = c(avg_revenue, avg_profit), 
                names_to = "metric", 
                values_to = "value") 
# Create the long format dataframe for rev & p
ship_margin_growth <- ship_analysis %>%
    group_by(ship_engine_size) %>%
    summarise(
        avg_p_cagr = mean(profit_CAGR, na.rm = TRUE),
        avg_margin = mean(profit_margin, na.rm = TRUE)
    ) %>%
    pivot_longer(cols = c(avg_margin, avg_p_cagr), 
                names_to = "metric", 
                values_to = "value") 

ship_combined <- bind_rows(
    ship_PnL %>% mutate(category = "Revenue & Profit"),
    ship_margin_growth %>% mutate(category = "Margin & Growth Rate")
)

ship_combined <- ship_combined %>%
  mutate(
    tooltip = paste0(
      "Ship Engine: ", ship_engine_size, 
      "\nAverage Annual Revenue: ", 
      round(value[metric == "avg_revenue"], 2), " K",       
      "\nAverage Annual Profit: ", 
      round(value[metric == "avg_profit"], 2), " K",
      "\nAverage Profit Margin: ", 
      round(value[metric == "avg_margin"]*100, 2), " %",
      "\nAverage Profit CAGR: ", 
      round(value[metric == "avg_p_cagr"]*100, 2), " %"
    )
  )

# Plot with Facet & Hover
p <- ggplot(ship_combined, 
       aes(x = factor(ship_engine_size, 
                      levels = ship_summary$ship_engine_size), 
           y = value,
           fill = metric)) +
  geom_bar_interactive(stat = "identity",
                       position = position_dodge(width = 0.8),
                       aes(tooltip = tooltip, 
                           data_id = ship_engine_size),
                       width = 0.7) +
  coord_flip() +
  facet_wrap(~ factor(category, levels = c("Revenue & Profit", "Margin & Growth Rate")),
             scales = "free_x") +  # Separate the two sections
  labs(
    title = "Sailing Towards Profit: Which Ship Types Lead the Way?",
    subtitle = "",
    x = "Ship Type, Size & Engine Type",
    y = "",
    fill = "Metric"
  ) +
  theme_classic() +
  scale_fill_manual(values = my_palette)+
  theme(
    axis.text.y = element_text(size = 4), 
    axis.text.x = element_text(size = 6),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 7, face = "bold"),  # Facet title size
    legend.position = "none",
    legend.title = element_text(size = 8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size = 8),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.background = element_rect(fill = "#f3f1e9", color = NA),
    plot.title = element_text(size = 11,hjust = 0.5,face='bold'),
    plot.margin = margin(10, 50, 10 ,20), 
    panel.spacing = unit(1, "lines"),
    strip.placement = "outside",  # Places strip above the panel
    strip.switch.pad.wrap = unit(2, "cm") 
  )

tooltip_css <- "background-color:white; font-style: bold; font-size:10px; color:black; border-radius: 5px; margin: 3px; padding:3px;"  

# Convert to Interactive
girafe(
  code = print(p), 
  width_svg = 6,
  height_svg = 4,
  options = list(
    opts_hover(css = "stroke-width:3px; opacity: 1;"),
    opts_hover_inv(css = "opacity: 0.2;"),
    opts_tooltip(css = tooltip_css)
  ))
```

```{r}
#| echo: false


p1 <- ggplot(ship_cleaned, aes(x = Revenue_per_Voyage_k, 
                                  y = Ship_Size,
                                  fill = Ship_Size)) +   
  geom_boxplot(aes(x = Revenue_per_Voyage_k), 
               width = 0.2, 
               position = position_dodge(width = 1), 
               alpha = 0.6,
               outliers = TRUE) +
  stat_dots(
            side = "left",
            justification = 1.2, 
            binwidth = NA,
            dotsize = 1
            )+
  scale_fill_manual(values = my_palette) +
  #facet_wrap(~Route_Type)+
  theme_ridges() +
  labs(title = "Does Smaller Ships earn more money?",
       subtitle = "No, actullay Very Large ships earn more.",
       x="Revenue" ,
       y="Ship Size")+
  theme(
    axis.text.y = element_text(size = 7), 
    axis.text.x = element_text(size = 7),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"), # Facet title size
    plot.margin = margin(10, 0, 0, 20),  #t,r,b,l
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=12,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )
    


p2<- ggplot(ship_cleaned, aes(x = Cost_per_Voyage_k, 
                                  y = Ship_Size,
                                  fill = Ship_Size)) +   
  geom_boxplot(aes(x = Cost_per_Voyage_k), 
               width = 0.2, 
               position = position_dodge(width = 1), 
               alpha = 0.6,
               outliers = TRUE) +
  stat_dots(
            side = "left",
            justification = 1.2, 
            binwidth = NA,
            dotsize = 1
            )+
  scale_fill_manual(values = my_palette) +
  theme_ridges() +
  labs(title = "",
       subtitle = "",
       x="Operational Cost" ,
       y="")+
  theme(
    axis.text.y = element_text(size = 7), 
    axis.text.x = element_text(size = 7),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"), # Facet title size
    plot.margin = margin(0, 0, 0, 0),  #t,r,b,l
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=12,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )

p3<- ggplot(ship_cleaned, aes(x = Net_profit_per_Voyage, 
                                  y = Ship_Size,
                                  fill = Ship_Size)) +   
  geom_boxplot(aes(x = Net_profit_per_Voyage), 
               width = 0.2, 
               position = position_dodge(width = 1), 
               alpha = 0.6,
               outliers = TRUE) +
  stat_dots(
            side = "left",
            justification = 1.2, 
            binwidth = NA,
            dotsize = 1
            )+
  scale_fill_manual(values = my_palette) +
  theme_ridges() +
  labs(
       x="Profit" ,
       y="")+
  theme(
    axis.text.y = element_text(size = 7), 
    axis.text.x = element_text(size = 7),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"), # Facet title size
    plot.margin = margin(0,0,10,0),  #t,r,b,l
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=12,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )


p4<- ggplot(ship_cleaned, aes(x = Net_margin_per_Voyage, 
                                  y = Ship_Size,
                                  fill = Ship_Size)) +   
  geom_boxplot(aes(x = Net_margin_per_Voyage), 
               width = 0.2, 
               position = position_dodge(width = 1), 
               alpha = 0.6,
               outliers = TRUE) +
  stat_dots(
            side = "left",
            justification = 1.2, 
            binwidth = NA,
            dotsize = 1
            )+
  scale_fill_manual(values = my_palette) +
  theme_ridges() +
  labs(
       x="Net Margin" ,
       y="")+
  theme(
    axis.text.y = element_text(size = 7), 
    axis.text.x = element_text(size = 7),  
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    strip.text = element_text(size = 9, face = "bold"), # Facet title size
    plot.margin = margin(10,20,10,0),  #t,r,b,l
    legend.position = "none",
    legend.title = element_text(size=8),
    legend.key.size = unit(0.3, "cm"),
    legend.text = element_text(size=6),
    legend.background = element_rect(fill = "#f3f1e9"),
    panel.background = element_rect(fill = "#f3f1e9"),
    plot.title = element_text(size=12,hjust=0),
    plot.subtitle = element_text(size=8,hjust=0),
    plot.background = element_rect(fill = "#f3f1e9",color = NA)
    )

patch_5 <- p1+p2+p3+p4
patch_5&
  theme(
    plot.margin = margin(0, 0, 0, 0),  # Removes extra space around the combined plots
    plot.background = element_rect(fill = "#f3f1e9", color = NA) 
  )
```
